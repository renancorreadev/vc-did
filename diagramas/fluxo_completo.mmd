sequenceDiagram
  autonumber
  participant U as Carteira do Usuário
  participant P as Verificador Parceiro
  participant ADM as Admin
  participant GW as Kong Gateway
  participant ISS as API Emissor
  participant VER as API Verificador
  participant CUST as Serviço de Custódia
  participant ANCH as Serviço de Âncora
  participant RES as Resolvedor DID/Status
  participant KC as Keycloak
  participant S3 as StatusList Store
  participant DID as DID Docs
  participant DIDSC as SC Registro DID
  participant STSC as SC StatusList

  rect lightgray
    Note over U,ISS: Fluxo de emissão
    U->>GW: Solicitar emissão
    GW->>ISS: Requisição de emissão
    ISS->>KC: Autenticar escopo
    KC-->>ISS: Token OK
    ISS->>CUST: Assinar payload da credencial
    CUST-->>ISS: Assinatura OK
    ISS->>S3: Gravar ou atualizar StatusList
    ISS->>ANCH: Publicar âncora (hash e versão)
    ANCH->>STSC: Publicar âncora de status
    ANCH->>DIDSC: Atualização de DID (opcional)
    STSC-->>ANCH: Transação confirmada
    ISS-->>GW: Credencial emitida
    GW-->>U: Credencial entregue
  end

  rect lightgray
    Note over P,VER: Fluxo de verificação
    P->>GW: Iniciar verificação
    GW->>VER: Requisição de verificação
    VER->>RES: Resolver chaves e status
    RES->>DID: Obter DID Document
    RES->>DIDSC: Ler atributos DID (opcional)
    RES->>STSC: Ler âncora de status
    RES->>S3: Baixar StatusList por URI
    RES-->>VER: Resultado da resolução
    VER-->>GW: Decisão
    GW-->>P: Resultado final
  end

  rect lightgray
    Note over ADM,ISS: Fluxo de revogação
    ADM->>GW: Solicitar revogação
    GW->>ISS: Comando de revogação
    ISS->>S3: Atualizar bit na StatusList
    ISS->>ANCH: Publicar nova versão
    ANCH->>STSC: Atualizar âncora
    STSC-->>ANCH: Transação confirmada
    ISS-->>GW: Revogado
    GW-->>ADM: Concluído
  end
