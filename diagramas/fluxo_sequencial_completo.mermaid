sequenceDiagram
  autonumber
  participant U as Carteira do usuario
  participant P as Parceiro verificador
  participant ADM as Administrador
  participant K as Kong
  participant ISS as API Emissor
  participant VER as API Verificador
  participant CUST as Servico de custodia
  participant ANCH as Servico de ancora
  participant RES as Resolvedor did e status
  participant KC as Keycloak
  participant S3 as StatusList store
  participant DID as DID docs
  participant STSC as SC StatusList
  participant DIDSC as SC DID registry

  rect lightgray
    Note over U,ISS: Emissao
    U->>K: solicitar emissao
    K->>ISS: encaminhar requisicao
    ISS->>KC: autenticar escopo
    KC-->>ISS: token valido
    ISS->>CUST: pedir assinatura da credencial
    CUST-->>ISS: assinatura ok
    ISS->>S3: atualizar statuslist
    ISS->>ANCH: publicar ancora com hash e versao
    ANCH->>STSC: gravar ancora de status
    ANCH->>DIDSC: atualizar did opcional
    ISS-->>K: retornar credencial
    K-->>U: entregar credencial
  end

  rect lightgray
    Note over P,VER: Verificacao
    P->>K: iniciar verificacao
    K->>VER: encaminhar verificacao
    VER->>RES: resolver chaves e status
    RES->>DID: obter did document
    RES->>STSC: ler ancora de status
    RES->>S3: baixar statuslist por uri
    RES-->>VER: resultado da resolucao
    VER-->>K: decisao
    K-->>P: resultado final
  end

  rect lightgray
    Note over ADM,ISS: Revogacao
    ADM->>K: solicitar revogacao
    K->>ISS: encaminhar revogacao
    ISS->>S3: marcar como revogado
    ISS->>ANCH: publicar nova versao
    ANCH->>STSC: atualizar ancora
    ISS-->>K: revogacao concluida
    K-->>ADM: confirmacao
  end
